# Практическая работа: Ассемблер для Учебной Виртуальной Машины (УВМ)

**Вариант №23**  
**Студент:** Цветкова Е.А.  
**Группа:** ИКБО-17-22

---

## 1. Общее описание

Проект представляет собой ассемблер и интерпретатор для учебной виртуальной машины (УВМ). Реализация выполнена на языке Python 3. Проект разрабатывается в несколько этапов, текущий этап — реализация ассемблера, преобразующего текстовое представление программы в промежуточное представление и бинарный формат, соответствующий спецификации УВМ.

### Архитектура УВМ:
- **Стековая архитектура**
- **4 типа команд:** CONST, LOAD, STORE, BITREV
- **Размер команды:** 4 байта
- **Формат команды:** 6 бит для кода операции (A), 26 бит для аргумента (B)

### Команды УВМ:
1. **CONST (A=42)** - загрузка константы на стек
2. **LOAD (A=23)** - чтение значения из памяти по адресу
3. **STORE (A=1)** - запись значения в память
4. **BITREV (A=60)** - унарная операция обращения битов

## 2. Описание всех функций и настроек

### Основные модули:

#### `assembler.py` - основной модуль ассемблера

**Класс `Assembler`**:
- `__init__()` - инициализация ассемблера
- `parse_line(line: str)` - разбор одной строки ассемблерного кода
- `parse_number(s: str)` - преобразование строки в число (поддерживает десятичный, шестнадцатеричный, двоичный, восьмеричный форматы)
- `assemble(source: str)` - двухпроходное ассемблирование исходного текста
- `encode_instruction(cmd: dict)` - кодирование команды в бинарный формат
- `to_binary(program: list)` - преобразование всей программы в бинарный формат
- `format_intermediate(program: list)` - форматирование промежуточного представления для отладки

**Перечисление `Opcode`**:
- `STORE = 1`
- `LOAD = 23` 
- `CONST = 42`
- `BITREV = 60`

**Словарь мнемоник `MNEMONICS`**:
- `'store'` → `Opcode.STORE`
- `'load'` → `Opcode.LOAD`
- `'const'` → `Opcode.CONST`
- `'bitrev'` → `Opcode.BITREV`

**Функция `main()`**:
- Обработка аргументов командной строки
- Чтение исходного файла
- Вызов ассемблирования
- Запись результата в бинарный файл

### Промежуточное представление:
Каждая команда представляется в виде словаря:
```python
{
    'address': 0,           # Адрес команды в памяти
    'opcode': 42,           # Числовой код операции
    'mnemonic': 'const',    # Текстовая мнемоника
    'args': ['125'],        # Аргументы из исходного текста
    'value': 125,           # Распарсенное значение (для CONST)
    'address_arg': 558,     # Распарсенный адрес (для LOAD)
    'raw_line': 'const 125' # Исходная строка
}
```
### Настройки:
- Кодировка файлов: UTF-8
- Порядок байт: little-endian (`<` в struct.pack)
- Размер слова: 4 байта
- Поддерживаемые системы счисления: десятичная, шестнадцатеричная (0x), двоичная (0b), восьмеричная (0o)

## 3. Описание команд для сборки проекта и запуска тестов

### Требования к окружению:
- Python 3.6 или выше
- Стандартные библиотеки Python (struct, enum, typing, sys)
### Установка:
```bash
# Клонирование репозитория (пример)
git clone https://github.com/username/uvm-assembler.git
cd uvm-assembler

# Проверка версии Python
python3 --version
```

### Основные команды:
**Компиляция программы**:
```bash
# Базовый синтаксис
python3 assembler.py <входной_файл.asm> <выходной_файл.bin>

# Пример
python3 assembler.py program.asm program.bin
```
**Компиляция с отладкой (режим тестирования)**:
```bash
python3 assembler.py program.asm program.bin --test
```
**Запуск тестов из спецификации УВМ**:
```bash
python3 run_tests.py
```
**Создание и тестирование примеров**:
```bash
# Создание тестового файла
echo "const 125" > test.asm
echo "load 558" >> test.asm
echo "store" >> test.asm
echo "bitrev" >> test.asm

# Компиляция с выводом промежуточного представления
python3 assembler.py test.asm test.bin --test

# Просмотр бинарного файла (Linux/macOS)
hexdump -C test.bin
```
### Аргументы командной строки assembler.py:

```bash
# Синтаксис:
python3 assembler.py <input.asm> <output.bin> [--test]

# Параметры:
#   <input.asm>   - обязательный, путь к исходному файлу .asm
#   <output.bin>  - обязательный, путь к выходному файлу .bin  
#   --test        - необязательный, включает режим тестирования

# Примеры:
python3 assembler.py test_program.asm program.bin
python3 assembler.py test_program.asm program.bin --test
```
### Файлы проекта
- `assembler.py` - основной модуль ассемблера
- `test_program.asm` - пример программы с тестами из спецификации
- `run_tests.py` - скрипт для запуска автотестов
- `README.md` - документация (этот файл)

## 4. Примеры использования
### Пример 1: Базовые команды из спецификации
Файл `test.asm`:
```asm
; Тестовая программа с командами из спецификации УВМ
const 125     ; Загрузка константы 125 (A=42, B=125)
load 558      ; Чтение из памяти по адресу 558 (A=23, B=558)
store         ; Запись в память (A=1)
bitrev        ; Обращение битов (A=60)
```
**Компиляция и запуск:**
```bash
python3 assembler.py test.asm output.bin --test
```
**Ожидаемый вывод:**
```text
=== ПРОМЕЖУТОЧНОЕ ПРЕДСТАВЛЕНИЕ ===
[0000] CONST 125 (0x7D)
  A биты 0-5: 101010 = 42
  B биты 6-21: 0000000001111101 = 125

[0001] LOAD 558 (0x22E)
  A биты 0-5: 010111 = 23
  B биты 6-29: 000000000000001000101110 = 558

[0002] STORE
  A биты 0-5: 000001 = 1

[0003] BITREV
  A биты 0-5: 111100 = 60

=== БИНАРНОЕ ПРЕДСТАВЛЕНИЕ (hex) ===
Слово 0: [0x6A, 0x1F, 0x00, 0x00]
Слово 1: [0x97, 0x8B, 0x00, 0x00]
Слово 2: [0x01, 0x00, 0x00, 0x00]
Слово 3: [0x3C, 0x00, 0x00, 0x00]

Успешно! Скомпилировано 4 команд в spec_test.bin
```
### Пример 2: Использование меток и разных систем счисления
Файл `advanced.asm`:
```asm
; Программа с метками и разными форматами чисел
start:
    const 100        ; Десятичное число
    const 0x64       ; Шестнадцатеричное (эквивалентно 100)
    const 0b1100100  ; Двоичное (эквивалентно 100)
    const 0144       ; Восьмеричное (эквивалентно 100)
    
    load start       ; Использование метки как адреса
    store
    
loop:
    bitrev
    load loop        ; Загрузка адреса метки loop
```
**Компиляция:**
```bash
python3 assembler.py advanced.asm advanced.bin --test
```
### Пример 3: Проверка соответствия спецификации
Запуск тестов:
```bash
python3 run_tests.py
```
Ожидаемый вывод тестов:
```text
=== ТЕСТЫ ИЗ СПЕЦИФИКАЦИИ УВМ ===

1. Тест CONST (A=42, B=125):
   Ожидается: 0x6A, 0x1F, 0x00, 0x00
   Получено:  0x6A, 0x1F, 0x00, 0x00
   Совпадение: True

2. Тест LOAD (A=23, B=558):
   Ожидается: 0x97, 0x8B, 0x00, 0x00
   Получено:  0x97, 0x8B, 0x00, 0x00
   Совпадение: True

3. Тест STORE (A=1):
   Ожидается: 0x01, 0x00, 0x00, 0x00
   Получено:  0x01, 0x00, 0x00, 0x00
   Совпадение: True

4. Тест BITREV (A=60):
   Ожидается: 0x3C, 0x00, 0x00, 0x00
   Получено:  0x3C, 0x00, 0x00, 0x00
   Совпадение: True
```
### Пример 4: Обработка ошибок
Некорректная программа (`error.asm`):
```asm
; Файл с ошибками для тестирования обработки исключений
; Ошибка 1: CONST без аргумента
const        ; Ошибка: нет аргумента
; Ошибка 2: LOAD без аргумента
load         ; Ошибка: нет аргумента
; Ошибка 3: Неизвестная мнемоника
unknown_cmd  ; Ошибка: неизвестная мнемоника
; Ошибка 4: CONST с числом вне диапазона
const 999999 ; Ошибка: значение вне диапазона
```
Попытка компиляции:
```bash
python3 assembler.py error.asm error.bin
```
Ожидаемый вывод:
```text
Ошибка: Строка 4: CONST требует 1 аргумент: const
```
